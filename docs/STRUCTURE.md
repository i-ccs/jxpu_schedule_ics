# é¡¹ç›®ç»“æ„æ–‡æ¡£

è¯¦ç»†çš„é¡¹ç›®æ¶æ„å’Œæ–‡ä»¶è¯´æ˜

---

## ç›®å½•

1. [æ–‡ä»¶ç»“æ„](#æ–‡ä»¶ç»“æ„)
2. [æ ¸å¿ƒæ¨¡å—è¯´æ˜](#æ ¸å¿ƒæ¨¡å—è¯´æ˜)
3. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
4. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
5. [æ•°æ®æµç¨‹](#æ•°æ®æµç¨‹)
6. [ç¼“å­˜æœºåˆ¶](#ç¼“å­˜æœºåˆ¶)

---

## æ–‡ä»¶ç»“æ„

```
schedule-subscription/
â”œâ”€â”€ ğŸ“ src/                          # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ ğŸ“„ server.js                # Hono ä¸»æœåŠ¡å™¨
â”‚   â”œâ”€â”€ ğŸ“„ config.js                # é…ç½®åŠ è½½æ¨¡å—
â”‚   â”œâ”€â”€ ğŸ“„ auth.js                  # è®¤è¯æ¨¡å—
â”‚   â”œâ”€â”€ ğŸ“„ db.js                    # æ•°æ®åº“æ“ä½œ
â”‚   â”œâ”€â”€ ğŸ“„ parser.js                # è¯¾è¡¨è§£æ
â”‚   â”œâ”€â”€ ğŸ“„ ical.js                  # ICS ç”Ÿæˆ
â”‚   â”œâ”€â”€ ğŸ“„ cache-manager.js         # ç¼“å­˜ç®¡ç†
â”‚   â””â”€â”€ ğŸ“ routers/
â”‚       â””â”€â”€ ğŸ“„ router.js            # è·¯ç”±é…ç½®
â”‚
â”œâ”€â”€ ğŸ“ public/                       # é™æ€æ–‡ä»¶
â”‚   â””â”€â”€ ğŸ“„ login.html               # ç™»å½•é¡µé¢
â”‚
â”œâ”€â”€ ğŸ“ docs/                         # æ–‡æ¡£ç›®å½•
â”‚   â”œâ”€â”€ ğŸ“„ README.md                # é¡¹ç›®è¯´æ˜
â”‚   â”œâ”€â”€ ğŸ“„ API.md                   # API æ–‡æ¡£
â”‚   â”œâ”€â”€ ğŸ“„ DEBUG.md                 # è°ƒè¯•æŒ‡å—
â”‚   â”œâ”€â”€ ğŸ“„ STRUCTURE.md             # é¡¹ç›®ç»“æ„
â”‚   â””â”€â”€ ğŸ“„ QUICKSTART.md            # å¿«é€Ÿå¼€å§‹
â”‚
â”œâ”€â”€ ğŸ“ cache/                        # ç¼“å­˜ç›®å½•(è‡ªåŠ¨ç”Ÿæˆ)
â”‚   â”œâ”€â”€ ğŸ“„ cache-index.json         # ç¼“å­˜ç´¢å¼•
â”‚   â””â”€â”€ ğŸ“„ *.ics                    # ç¼“å­˜çš„ ICS æ–‡ä»¶
â”‚
â”œâ”€â”€ ğŸ“„ .env.example                 # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”œâ”€â”€ ğŸ“„ .env                         # ç¯å¢ƒå˜é‡é…ç½®(éœ€åˆ›å»º)
â”œâ”€â”€ ğŸ“„ package.json                 # é¡¹ç›®é…ç½®
â”œâ”€â”€ ğŸ“„ package-lock.json            # ä¾èµ–é”å®š
â”œâ”€â”€ ğŸ“Š schedule_server.db           # SQLite æ•°æ®åº“(è‡ªåŠ¨ç”Ÿæˆ)
â”œâ”€â”€ ğŸ“„ .gitignore                   # Git å¿½ç•¥æ–‡ä»¶
â””â”€â”€ ğŸ“ node_modules/                # ä¾èµ–åŒ…(è‡ªåŠ¨ç”Ÿæˆ)
```

---

## æ ¸å¿ƒæ¨¡å—è¯´æ˜

### 1. server.js

**åŠŸèƒ½**: Hono åº”ç”¨ä¸»æœåŠ¡å™¨

**èŒè´£**:
- åˆå§‹åŒ– Hono åº”ç”¨
- æŒ‚è½½è·¯ç”±
- åˆå§‹åŒ–æ•°æ®åº“
- åˆå§‹åŒ–ç¼“å­˜ç›®å½•
- å¯åŠ¨å®šæ—¶ä»»åŠ¡
- å¯åŠ¨ HTTP æœåŠ¡å™¨

**å…³é”®ä»£ç **:

```javascript
const app = new Hono();
app.route('/', router);

// å¯åŠ¨æœåŠ¡
await db.initDB();
await cacheManager.initCacheDir();
cacheManager.startScheduledUpdate();

serve({ fetch: app.fetch, port: 3000 });
```

---

### 2. config.js

**åŠŸèƒ½**: é…ç½®åŠ è½½å’Œç®¡ç†

**èŒè´£**:
- åŠ è½½ .env æ–‡ä»¶
- æä¾›é…ç½®å¯¹è±¡
- éªŒè¯é…ç½®æœ‰æ•ˆæ€§
- æ˜¾ç¤ºé…ç½®ä¿¡æ¯

**é…ç½®é¡¹**:

| é…ç½®é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| PORT | 3000 | æœåŠ¡å™¨ç«¯å£ |
| NODE_ENV | development | è¿è¡Œç¯å¢ƒ |
| ADMIN_PASSWORD | admin123 | ç®¡ç†å‘˜å¯†ç  |
| DB_PATH | schedule_server.db | æ•°æ®åº“è·¯å¾„ |
| CACHE_DIR | cache | ç¼“å­˜ç›®å½• |
| UPDATE_HOURS | [5,13,21] | æ›´æ–°æ—¶é—´ç‚¹ |

**ä½¿ç”¨æ–¹å¼**:

```javascript
const { config } = require('./config');
console.log('ç«¯å£:', config.port);
```

---

### 3. auth.js

**åŠŸèƒ½**: è®¤è¯å’Œè¯¾è¡¨è·å–

**ä¸»è¦å‡½æ•°**:

#### `generateQRCode()`
ç”Ÿæˆç™»å½•äºŒç»´ç å¹¶è·å– SESSION Cookie

**æµç¨‹**:
1. ç”Ÿæˆè·Ÿè¸ª Cookie
2. è®¿é—®ç™»å½•é¡µé¢
3. è¯·æ±‚äºŒç»´ç å›¾ç‰‡(æœ€å¤šé‡è¯•3æ¬¡)
4. è¿”å›äºŒç»´ç å’Œ Cookie

**è¿”å›å€¼**:
```javascript
{
  success: true,
  qrCodeId: "173226240012345",
  imageBuffer: Buffer,
  cookies: { SESSION: "xxx", ... }
}
```

#### `pollQRCodeStatus(qrCodeId, cookies)`
è½®è¯¢äºŒç»´ç æ‰«ç çŠ¶æ€

**å‚æ•°**:
- `qrCodeId`: äºŒç»´ç ID
- `cookies`: åŒ…å« SESSION çš„ Cookie å¯¹è±¡

**è¿”å›å€¼**:
```javascript
{
  success: true,
  status: "3",  // 0=ç­‰å¾…, 2=å·²æ‰«ç , 3=å·²ç¡®è®¤
  stateKey: "xxx",
  userId: "20231001",
  username: "å¼ ä¸‰"
}
```

#### `loginWithStateKey(stateKey, fpVisitorId, sessionCookies)`
ä½¿ç”¨ stateKey å®Œæˆç™»å½•

**è¿”å›å€¼**:
```javascript
{
  success: true,
  cookies: { TGC: "xxx", ... }
}
```

#### `fetchSchedule(cookies)`
è·å–è¯¾è¡¨ HTML

**æµç¨‹**:
1. SSO ç™»å½•éªŒè¯
2. è®¿é—®æ•™åŠ¡ç³»ç»Ÿ
3. è·å–è¯¾è¡¨é¡µé¢
4. éªŒè¯å“åº”æœ‰æ•ˆæ€§

**è¿”å›å€¼**:
```javascript
{
  success: true,
  html: "<html>...</html>"
}
```

---

### 4. db.js

**åŠŸèƒ½**: æ•°æ®åº“æ“ä½œ

**ä¸»è¦å‡½æ•°**:

| å‡½æ•° | åŠŸèƒ½ |
|------|------|
| `initDB()` | åˆå§‹åŒ–æ•°æ®åº“ |
| `saveUser()` | ä¿å­˜ç”¨æˆ·ä¿¡æ¯ |
| `getUser()` | è·å–ç”¨æˆ·ä¿¡æ¯ |
| `deleteUser()` | åˆ é™¤ç”¨æˆ· |
| `findUserByUserId()` | æ ¹æ®ç”¨æˆ·IDæŸ¥æ‰¾ |
| `findUserByUsername()` | æ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾ |
| `updateLastSync()` | æ›´æ–°åŒæ­¥æ—¶é—´ |
| `markCookieInvalid()` | æ ‡è®°Cookieæ— æ•ˆ |

**ä½¿ç”¨ç¤ºä¾‹**:

```javascript
// ä¿å­˜ç”¨æˆ·
await db.saveUser(token, cookies, semesterStart, userId, username);

// è·å–ç”¨æˆ·
const user = await db.getUser(token);

// æ£€æŸ¥Cookieæœ‰æ•ˆæ€§
if (!user.cookieValid) {
    await db.markCookieInvalid(token);
}
```

---

### 5. parser.js

**åŠŸèƒ½**: è¯¾è¡¨ HTML è§£æ

**ä¸»è¦å‡½æ•°**:

#### `parseSchedule(html, semesterStart)`
è§£æè¯¾è¡¨ HTML,æå–è¯¾ç¨‹ä¿¡æ¯

**æµç¨‹**:
1. ä½¿ç”¨ Cheerio åŠ è½½ HTML
2. éå†è¯¾è¡¨å•å…ƒæ ¼
3. è§£æè¯¾ç¨‹ä¿¡æ¯
4. è®¡ç®—æ—¶é—´
5. ç”Ÿæˆè¯¾ç¨‹æ•°ç»„

**è¯¾ç¨‹å¯¹è±¡**:
```javascript
{
  name: "é«˜ç­‰æ•°å­¦",
  location: "æ•™å­¦æ¥¼A101",
  teacher: "å¼ è€å¸ˆ",
  week: 1,
  startTime: Date,
  endTime: Date
}
```

#### `cleanCourseName(rawName)`
æ¸…ç†è¯¾ç¨‹åç§°

**å¤„ç†é€»è¾‘**:
1. ç§»é™¤ HTML æ ‡ç­¾
2. è§£ç  HTML å®ä½“
3. å»é™¤ç©ºç™½å­—ç¬¦
4. è§„èŒƒåŒ–æ ¼å¼

**èŠ‚æ¬¡æ—¶é—´æ˜ å°„**:

```javascript
const lessonTimes = {
    1: ['08:20', '10:00'],  // ç¬¬1-2èŠ‚
    2: ['10:20', '12:00'],  // ç¬¬3-4èŠ‚
    3: ['14:00', '15:40'],  // ç¬¬5-6èŠ‚
    4: ['16:00', '17:35'],  // ç¬¬7-8èŠ‚
    5: ['17:40', '19:20'],  // ç¬¬9-10èŠ‚
    6: ['19:30', '21:10']   // ç¬¬11-12èŠ‚
};
```

---

### 6. ical.js

**åŠŸèƒ½**: ICS æ—¥å†æ–‡ä»¶ç”Ÿæˆ

**ä¸»è¦å‡½æ•°**:

#### `generateICS(courses)`
ç”Ÿæˆ ICS æ ¼å¼çš„æ—¥å†æ–‡ä»¶

**é…ç½®**:
- æ—¥å†åç§°: "æˆ‘çš„è¯¾ç¨‹è¡¨"
- æ—¶åŒº: Asia/Shanghai
- åˆ·æ–°é—´éš”: 1å°æ—¶
- æé†’æ—¶é—´: ä¸Šè¯¾å‰35åˆ†é’Ÿ

**äº‹ä»¶å±æ€§**:
```javascript
{
  start: course.startTime,
  end: course.endTime,
  summary: course.name,
  description: `æ•™å¸ˆ: ${course.teacher}\nç¬¬${course.week}å‘¨`,
  location: course.location,
  uid: "unique-id@jxpu.edu.cn",
  alarms: [{ type: 'display', trigger: 35 * 60 }]
}
```

---

### 7. cache-manager.js

**åŠŸèƒ½**: ç¼“å­˜ç®¡ç†å’Œå®šæ—¶æ›´æ–°

**ä¸»è¦å‡½æ•°**:

#### `getCachedSchedule(token)`
è·å–ç¼“å­˜çš„è¯¾è¡¨(å¦‚æœè¿‡æœŸåˆ™é‡æ–°ç”Ÿæˆ)

**ç¼“å­˜ç­–ç•¥**:
- ç¼“å­˜æœ‰æ•ˆæœŸ: åˆ°ä¸‹æ¬¡æ›´æ–°æ—¶é—´
- æ›´æ–°æ—¶é—´: æ¯å¤© 5:00ã€13:00ã€21:00
- è¿‡æœŸå¤„ç†: è‡ªåŠ¨é‡æ–°ç”Ÿæˆ

#### `generateAndCacheSchedule(token)`
ç”Ÿæˆå¹¶ç¼“å­˜è¯¾è¡¨

**æµç¨‹**:
1. è·å–ç”¨æˆ·ä¿¡æ¯
2. éªŒè¯ Cookie
3. è·å–è¯¾è¡¨æ•°æ®
4. è§£æè¯¾ç¨‹
5. ç”Ÿæˆ ICS
6. ä¿å­˜åˆ°æ–‡ä»¶
7. æ›´æ–°ç´¢å¼•

#### `startScheduledUpdate()`
å¯åŠ¨å®šæ—¶æ›´æ–°ä»»åŠ¡

**æ›´æ–°æœºåˆ¶**:
1. è®¡ç®—è·ç¦»ä¸‹æ¬¡æ›´æ–°çš„æ—¶é—´
2. ä½¿ç”¨ setTimeout è®¾ç½®å®šæ—¶å™¨
3. åˆ°æ—¶é—´åæ›´æ–°æ‰€æœ‰ç¼“å­˜
4. é€’å½’è°ƒç”¨,è®¾ç½®ä¸‹ä¸€æ¬¡æ›´æ–°

#### `clearUserCache(token)`
æ¸…ç†æŒ‡å®šç”¨æˆ·çš„ç¼“å­˜

**æ“ä½œ**:
1. åˆ é™¤ç¼“å­˜æ–‡ä»¶
2. æ›´æ–°ç¼“å­˜ç´¢å¼•
3. è®°å½•æ—¥å¿—

---

### 8. router.js

**åŠŸèƒ½**: API è·¯ç”±å®šä¹‰å’Œå¤„ç†

**è·¯ç”±åˆ—è¡¨**:

| è·¯ç”± | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| /api/qr/generate | GET | ç”ŸæˆäºŒç»´ç  |
| /api/qr/status | POST | è½®è¯¢çŠ¶æ€ |
| /api/qr/login | POST | å®Œæˆç™»å½• |
| /api/keepalive | POST | ä¼šè¯ä¿æ´» |
| /schedule/:token | GET | è¯¾è¡¨è®¢é˜… |
| /api/download/:token | GET | ä¸‹è½½è¯¾è¡¨ |
| /api/user/:token | DELETE | åˆ é™¤è´¦å· |
| /api/cache/refresh/:token | POST | åˆ·æ–°ç¼“å­˜ |
| /api/cache/stats | GET | ç¼“å­˜ç»Ÿè®¡ |
| /api/cache/clear | POST | æ¸…ç†ç¼“å­˜ |
| /api/stats | GET | ç³»ç»Ÿç»Ÿè®¡ |
| /login | GET | ç™»å½•é¡µé¢ |

**ä¼šè¯ç®¡ç†**:

```javascript
// ä¼šè¯å­˜å‚¨
const sessionStorage = new Map();

// ä¿å­˜ä¼šè¯
saveSession(sessionId, {
    cookies: {...},
    qrCodeId: "xxx",
    timestamp: Date.now()
});

// è‡ªåŠ¨æ¸…ç†(æ¯10åˆ†é’Ÿ)
setInterval(() => {
    const twoHours = 2 * 60 * 60 * 1000;
    for (const [id, session] of sessionStorage.entries()) {
        if (Date.now() - session.timestamp > twoHours) {
            sessionStorage.delete(id);
        }
    }
}, 10 * 60 * 1000);
```

---

## æ•°æ®åº“è®¾è®¡

### users è¡¨

**è¡¨ç»“æ„**:

```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    token TEXT UNIQUE NOT NULL,
    cookies TEXT NOT NULL,
    semester_start TEXT NOT NULL,
    user_id TEXT,
    username TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_sync TIMESTAMP,
    cookie_valid INTEGER DEFAULT 1,
    cookie_expired_at TIMESTAMP
);
```

**å­—æ®µè¯´æ˜**:

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| id | INTEGER | ä¸»é”®,è‡ªå¢ | 1 |
| token | TEXT | è®¢é˜…Token(å”¯ä¸€) | AbCdEf... |
| cookies | TEXT | Cookie JSON | {"TGC":"xxx"} |
| semester_start | TEXT | å­¦æœŸå¼€å§‹æ—¥æœŸ | 2025-09-08 |
| user_id | TEXT | ç”¨æˆ·ID | 20231001 |
| username | TEXT | ç”¨æˆ·å | å¼ ä¸‰ |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | 2024-11-22 |
| last_sync | TIMESTAMP | æœ€ååŒæ­¥æ—¶é—´ | 2024-11-22 |
| cookie_valid | INTEGER | Cookieæœ‰æ•ˆæ€§ | 1=æœ‰æ•ˆ, 0=æ— æ•ˆ |
| cookie_expired_at | TIMESTAMP | è¿‡æœŸæ—¶é—´ | 2024-11-22 |

**ç´¢å¼•ä¼˜åŒ–**:

```sql
CREATE INDEX idx_token ON users(token);
CREATE INDEX idx_user_id ON users(user_id);
CREATE INDEX idx_cookie_valid ON users(cookie_valid);
```

**å¸¸ç”¨æŸ¥è¯¢**:

```sql
-- æŸ¥è¯¢æ‰€æœ‰æœ‰æ•ˆç”¨æˆ·
SELECT * FROM users WHERE cookie_valid = 1;

-- æŸ¥è¯¢ç‰¹å®šç”¨æˆ·
SELECT * FROM users WHERE token = 'xxx';

-- æ›´æ–°åŒæ­¥æ—¶é—´
UPDATE users SET last_sync = CURRENT_TIMESTAMP WHERE token = 'xxx';

-- æ ‡è®° Cookie æ— æ•ˆ
UPDATE users 
SET cookie_valid = 0, cookie_expired_at = CURRENT_TIMESTAMP 
WHERE token = 'xxx';

-- ç»Ÿè®¡ä¿¡æ¯
SELECT 
    COUNT(*) as total_users,
    SUM(CASE WHEN cookie_valid = 1 THEN 1 ELSE 0 END) as valid_users,
    SUM(CASE WHEN last_sync IS NOT NULL THEN 1 ELSE 0 END) as active_users
FROM users;
```

---

## æŠ€æœ¯æ¶æ„

### æŠ€æœ¯æ ˆ

| ç±»å‹ | æŠ€æœ¯ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|------|
| **Web æ¡†æ¶** | Hono | ^4.0.0 | è½»é‡çº§ã€é«˜æ€§èƒ½ |
| **Node.js é€‚é…å™¨** | @hono/node-server | ^1.8.0 | Hono Node.js è¿è¡Œæ—¶ |
| **HTTP è¯·æ±‚** | Fetch API | å†…ç½® | Node.js 18+ åŸç”Ÿ |
| **HTML è§£æ** | Cheerio | ^1.0.0 | æœåŠ¡ç«¯ jQuery |
| **æ—¥å†ç”Ÿæˆ** | ical-generator | ^4.1.0 | ICS ç”Ÿæˆ |
| **æ•°æ®åº“** | SQLite3 | ^5.1.6 | åµŒå…¥å¼æ•°æ®åº“ |
| **å¼€å‘å·¥å…·** | nodemon | ^3.0.2 | è‡ªåŠ¨é‡å¯ |

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯é¡µé¢ (login.html)                 â”‚
â”‚  - äºŒç»´ç ç”Ÿæˆä¸æ˜¾ç¤º                                      â”‚
â”‚  - çŠ¶æ€è½®è¯¢                                              â”‚
â”‚  - ä¼šè¯ä¿æ´»                                              â”‚
â”‚  - è®¢é˜…é“¾æ¥ç®¡ç†                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ HTTP/HTTPS
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Hono Web æœåŠ¡å™¨ (server.js)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ è·¯ç”±åˆ†å‘
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 è·¯ç”±å±‚ (router.js)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  /api/qr/generate      - ç”ŸæˆäºŒç»´ç                      â”‚
â”‚  /api/qr/status        - è½®è¯¢çŠ¶æ€                       â”‚
â”‚  /api/qr/login         - å®Œæˆç™»å½•                       â”‚
â”‚  /api/keepalive        - ä¼šè¯ä¿æ´»                       â”‚
â”‚  /schedule/:token      - è¯¾è¡¨è®¢é˜…                       â”‚
â”‚  /api/download/:token  - ä¸‹è½½ICS                        â”‚
â”‚  /api/user/:token      - åˆ é™¤è´¦å·                       â”‚
â”‚  /api/cache/*          - ç¼“å­˜ç®¡ç†                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
         â†“                 â†“          â†“          â†“        â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”
    â”‚è®¤è¯æ¨¡å— â”‚   â”‚è§£ææ¨¡å—  â”‚  â”‚ICSæ¨¡å— â”‚  â”‚DB   â”‚  â”‚ç¼“å­˜  â”‚
    â”‚auth.js  â”‚   â”‚parser.js â”‚  â”‚ical.js â”‚  â”‚db.jsâ”‚  â”‚cache â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”¤
    â”‚äºŒç»´ç    â”‚   â”‚HTMLè§£æ  â”‚  â”‚ç”ŸæˆICS â”‚  â”‚ç”¨æˆ· â”‚  â”‚å®šæ—¶  â”‚
    â”‚è½®è¯¢     â”‚   â”‚è¯¾ç¨‹æå–  â”‚  â”‚æ·»åŠ æé†’â”‚  â”‚ç®¡ç† â”‚  â”‚æ›´æ–°  â”‚
    â”‚ç™»å½•     â”‚   â”‚æ—¶é—´è®¡ç®—  â”‚  â”‚        â”‚  â”‚     â”‚  â”‚      â”‚
    â”‚è·å–è¯¾è¡¨ â”‚   â”‚          â”‚  â”‚        â”‚  â”‚     â”‚  â”‚      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜
         â”‚                 â”‚          â”‚          â”‚        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â†“
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  SQLite æ•°æ®åº“    â”‚
                  â”‚schedule_server.dbâ”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•°æ®æµç¨‹

### 1. ç™»å½•æµç¨‹

```
ç”¨æˆ· â†’ ç”ŸæˆäºŒç»´ç  â†’ æ‰‹æœºæ‰«ç  â†’ ç¡®è®¤ç™»å½• â†’ è·å–è¯¾è¡¨ â†’ ç”Ÿæˆè®¢é˜…
  â”‚         â”‚            â”‚          â”‚          â”‚           â”‚
  â”‚    åˆ›å»ºä¼šè¯      è½®è¯¢çŠ¶æ€   è·å–TGC    éªŒè¯Cookie   ä¿å­˜æ•°æ®åº“
  â”‚    SESSION       status=2    TGC       fetchSchedule  saveUser
  â”‚                  status=3    Cookie    è§£æè¯¾è¡¨        token
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           è¿”å›è®¢é˜…é“¾æ¥
```

### 2. è¯¾è¡¨åŒæ­¥æµç¨‹

```
æ—¥å†åº”ç”¨ â†’ è¯·æ±‚è®¢é˜… â†’ æ£€æŸ¥ç¼“å­˜ â†’ ç”Ÿæˆ/è¯»å– â†’ è¿”å›ICS
   â”‚          â”‚          â”‚           â”‚           â”‚
   â”‚     éªŒè¯token   cacheå­˜åœ¨?   fetchSchedule  è®¾ç½®ç¼“å­˜å¤´
   â”‚     getUser    æ˜¯â†’è¯»ç¼“å­˜    parseSchedule   CDNç¼“å­˜
   â”‚               å¦â†’ç”Ÿæˆæ–°     generateICS     æµè§ˆå™¨ç¼“å­˜
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      è‡ªåŠ¨æ›´æ–°è¯¾ç¨‹
```

### 3. ç¼“å­˜æ›´æ–°æµç¨‹

```
å®šæ—¶ä»»åŠ¡ â†’ éå†ç”¨æˆ· â†’ è·å–è¯¾è¡¨ â†’ ç”ŸæˆICS â†’ ä¿å­˜ç¼“å­˜
   â”‚          â”‚          â”‚          â”‚          â”‚
5/13/21ç‚¹  è·å–token  fetchSchedule generateICS writeFile
   â”‚       forå¾ªç¯    éªŒè¯Cookie   è§£æè¯¾ç¨‹    æ›´æ–°ç´¢å¼•
   â”‚       é—´éš”1ç§’    å¤±è´¥â†’æ ‡è®°   è®¡ç®—æ—¶é—´    è®°å½•æ—¥å¿—
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   ä¸‹æ¬¡å®šæ—¶æ›´æ–°
```

---

## ç¼“å­˜æœºåˆ¶

### ç¼“å­˜æ–‡ä»¶ç»“æ„

```
cache/
â”œâ”€â”€ cache-index.json          # ç¼“å­˜ç´¢å¼•æ–‡ä»¶
â”œâ”€â”€ a1b2c3d4e5f6.ics         # ç”¨æˆ·1çš„è¯¾è¡¨ç¼“å­˜
â”œâ”€â”€ f6e5d4c3b2a1.ics         # ç”¨æˆ·2çš„è¯¾è¡¨ç¼“å­˜
â””â”€â”€ ...
```

### ç¼“å­˜ç´¢å¼•æ ¼å¼

```json
{
  "token1": {
    "lastUpdate": 1732262400000,
    "nextUpdate": 1732270800000,
    "courses": 15,
    "username": "å¼ ä¸‰"
  },
  "token2": {
    "lastUpdate": 1732262400000,
    "nextUpdate": 1732270800000,
    "courses": 18,
    "username": "æå››"
  }
}
```

### ç¼“å­˜ç­–ç•¥

**æ›´æ–°æ—¶é—´**:
- æ¯å¤© 5:00ã€13:00ã€21:00 è‡ªåŠ¨æ›´æ–°
- å¯é€šè¿‡ç¯å¢ƒå˜é‡ `UPDATE_HOURS` é…ç½®

**æœ‰æ•ˆæœŸåˆ¤æ–­**:
```javascript
function isCacheExpired(lastUpdate) {
    const now = Date.now();
    const nextUpdate = getNextUpdateTime();
    const offset = (now - nextUpdate) % (24 * 60 * 60 * 1000);
    return lastUpdate < (now - offset);
}
```

**CDN ç¼“å­˜å¤´**:
```javascript
Cache-Control: public, max-age=3600, s-maxage=43200
ETag: "1732262400000"
Last-Modified: Fri, 22 Nov 2024 13:00:00 GMT
X-Cache-Status: HIT
X-Next-Update: 2024-11-22T21:00:00.000Z
```

### ç¼“å­˜æ¸…ç†

**æ‰‹åŠ¨æ¸…ç†**:
```bash
curl -X POST http://localhost:3000/api/cache/clear \
  -H "Content-Type: application/json" \
  -d '{"password":"admin_password"}'
```

**è‡ªåŠ¨æ¸…ç†**:
- ç”¨æˆ·åˆ é™¤è´¦å·æ—¶è‡ªåŠ¨æ¸…ç†å¯¹åº”ç¼“å­˜
- Cookie è¿‡æœŸæ—¶ä¸æ¸…ç†ç¼“å­˜(ä¿ç•™å†å²æ•°æ®)

---

## æ¨¡å—ä¾èµ–å…³ç³»

```
server.js
  â”œâ”€â”€ config.js
  â”œâ”€â”€ db.js
  â”œâ”€â”€ cache-manager.js
  â”‚   â”œâ”€â”€ auth.js
  â”‚   â”œâ”€â”€ parser.js
  â”‚   â”œâ”€â”€ ical.js
  â”‚   â””â”€â”€ db.js
  â””â”€â”€ routers/router.js
      â”œâ”€â”€ auth.js
      â”œâ”€â”€ db.js
      â”œâ”€â”€ cache-manager.js
      â””â”€â”€ config.js
```

---

**ğŸ“– æ·±å…¥äº†è§£é¡¹ç›®ç»“æ„æœ‰åŠ©äºæ›´å¥½åœ°å¼€å‘å’Œç»´æŠ¤!**