<!DOCTYPE html>
<html>
<head>
    <title>è¯¾è¡¨è®¢é˜…æœåŠ¡ - äºŒç»´ç ç™»å½•</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px;
            line-height: 1.6;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-bottom: 10px; font-size: 28px; }
        .subtitle { color: #666; margin-bottom: 30px; }
        .qr-container {
            text-align: center;
            padding: 30px;
            background: #f6f8fa;
            border-radius: 8px;
            margin: 20px 0;
        }
        .qr-image {
            max-width: 300px;
            margin: 20px auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
        .status {
            margin: 15px 0;
            font-size: 18px;
            font-weight: 600;
        }
        .status.waiting { color: #666; }
        .status.scanned { color: #0366d6; }
        .status.success { color: #28a745; }
        .status.error { color: #d73a49; }
        .status.expired { color: #e36209; }
        .status.existing { color: #0366d6; }
        .form-group { margin: 20px 0; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e1e4e8;
            border-radius: 6px;
            font-size: 14px;
        }
        button { 
            background: #0366d6;
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
        }
        button:hover { background: #0256c7; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .result { 
            margin-top: 20px; 
            padding: 15px; 
            background: #f6f8fa;
            border-radius: 6px;
            border-left: 4px solid #0366d6;
        }
        .result.success { color: #28a745; background: #dcffe4; border-left-color: #28a745; }
        .result.existing { color: #0366d6; background: #ddf4ff; border-left-color: #0366d6; }
        .result.error { color: #d73a49; background: #ffeef0; border-left-color: #d73a49; }
        code { 
            background: #f6f8fa;
            padding: 3px 6px; 
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            word-break: break-all;
        }
        .btn-copy {
            background: #28a745;
            margin-top: 10px;
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }
        .btn-delete {
            background: #d73a49;
            margin-top: 10px;
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
            margin-left: 10px;
        }
        .btn-delete:hover {
            background: #cb2431;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .timer {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
        .log {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“… è¯¾è¡¨è®¢é˜…æœåŠ¡</h1>
        <p class="subtitle">ä½¿ç”¨äºŒç»´ç æ‰«ç ç™»å½• (ä¼˜åŒ–ç‰ˆ - å®‰å…¨ä¼šè¯éš”ç¦» + è‡ªåŠ¨ä¿æ´»)</p>
        
        <div class="qr-container" id="qrContainer">
            <div class="status waiting" id="status">æ­£åœ¨åŠ è½½äºŒç»´ç ...</div>
            <div id="qrImage"></div>
            <div class="timer" id="timer"></div>
            <div class="log" id="log"></div>
            <button onclick="generateQR()" id="genBtn" style="display:none;">é‡æ–°ç”ŸæˆäºŒç»´ç </button>
        </div>
        
        <div class="form-group" id="semesterGroup" style="display:none;">
            <label>å­¦æœŸå¼€å§‹æ—¥æœŸ (ç¬¬ä¸€å‘¨å‘¨ä¸€):</label>
            <input type="date" id="semester_start" value="2025-09-08">
        </div>

        <div class="form-group" id="emailGroup" style="display:none;">
            <label>æ¥æ”¶é€šçŸ¥çš„é‚®ç®± (å¯é€‰):</label>
            <input type="email" id="email" placeholder="your-email@example.com">
            <p style="font-size: 12px; color: #666; margin-top: 5px;">
                ğŸ’¡ è®¾ç½®é‚®ç®±åï¼ŒCookieè¿‡æœŸæ—¶ä¼šæ”¶åˆ°é‚®ä»¶æé†’
            </p>
        </div>
        
        <div id="result" style="display:none;"></div>
    </div>
    
    <script>
    let pollInterval = null;
    let currentQrCodeId = null;
    let currentStateKey = null;
    let currentUserId = null;
    let currentUsername = null;
    let expiryTime = null;
    let timerInterval = null;
    let keepaliveInterval = null;
    
    function log(msg) {
        const logEl = document.getElementById('log');
        logEl.textContent = msg;
    }
    
    function updateTimer() {
        if (!expiryTime) return;
        
        const now = Date.now();
        const remaining = Math.max(0, Math.floor((expiryTime - now) / 1000));
        
        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        
        const timerEl = document.getElementById('timer');
        if (remaining > 0) {
            timerEl.textContent = `â±ï¸ æœ‰æ•ˆæœŸ: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            timerEl.style.color = '#666';
        } else {
            timerEl.textContent = 'â±ï¸ äºŒç»´ç å·²è¿‡æœŸ';
            timerEl.style.color = '#d73a49';
            
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
            if (keepaliveInterval) {
                clearInterval(keepaliveInterval);
                keepaliveInterval = null;
            }
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            const btn = document.getElementById('genBtn');
            const status = document.getElementById('status');
            btn.disabled = false;
            btn.style.display = 'block';
            btn.textContent = 'é‡æ–°ç”ŸæˆäºŒç»´ç ';
            status.className = 'status expired';
            status.textContent = 'â±ï¸ äºŒç»´ç å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç”Ÿæˆ';
        }
    }
    
    async function generateQR() {
        const btn = document.getElementById('genBtn');
        const status = document.getElementById('status');
        const qrImage = document.getElementById('qrImage');
        const timer = document.getElementById('timer');
        
        btn.disabled = true;
        btn.textContent = 'ç”Ÿæˆä¸­...';
        status.className = 'status waiting';
        status.textContent = 'æ­£åœ¨ç”ŸæˆäºŒç»´ç ...';
        qrImage.innerHTML = '';
        timer.textContent = '';
        log('');
        
        if (timerInterval) clearInterval(timerInterval);
        if (pollInterval) clearInterval(pollInterval);
        if (keepaliveInterval) clearInterval(keepaliveInterval);
        
        try {            
            const response = await fetch('/api/qr/generate');
            const data = await response.json();
            
            if (data.success) {
                currentQrCodeId = data.qrCodeId;
                
                log(`âœ… æˆåŠŸè·å–äºŒç»´ç ID: ${data.qrCodeId}`);
                
                const imageData = 'data:image/png;base64,' + data.imageData;
                qrImage.innerHTML = '<img src="' + imageData + '" style="width: 100%; max-width: 250px;">';
                status.textContent = 'è¯·ä½¿ç”¨æ‰‹æœºæ‰«ç ç™»å½•';
                btn.textContent = 'é‡æ–°ç”ŸæˆäºŒç»´ç ';
                btn.style.display = 'block';
                btn.disabled = false;
                document.getElementById('semesterGroup').style.display = 'block';
                document.getElementById('emailGroup').style.display = 'block';
                
                expiryTime = Date.now() + 127 * 1000;
                timerInterval = setInterval(updateTimer, 1000);
                updateTimer();
                
                startKeepalive();
                startPolling();
            } else {
                status.className = 'status error';
                status.textContent = 'ç”Ÿæˆå¤±è´¥: ' + data.error;
                log('âŒ ' + data.error);
                btn.disabled = false;
                btn.textContent = 'é‡æ–°ç”Ÿæˆ';
                btn.style.display = 'block';
            }
        } catch (error) {
            status.className = 'status error';
            status.textContent = 'ç½‘ç»œé”™è¯¯: ' + error.message;
            log('âŒ ' + error.message);
            btn.disabled = false;
            btn.textContent = 'é‡æ–°ç”Ÿæˆ';
            btn.style.display = 'block';
        }
    }
    
    async function startPolling() {
        if (pollInterval) clearInterval(pollInterval);
        
        pollInterval = setInterval(async () => {
            try {
                const response = await fetch('/api/qr/status', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        qrCodeId: currentQrCodeId
                    })
                });
                
                const data = await response.json();
                
                if (data.code === 1 && data.message === 'expired') {
                    const status = document.getElementById('status');
                    status.className = 'status expired';
                    status.textContent = 'â±ï¸ äºŒç»´ç å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç”Ÿæˆ';
                    
                    clearInterval(pollInterval);
                    if (timerInterval) clearInterval(timerInterval);
                    if (keepaliveInterval) clearInterval(keepaliveInterval);
                    
                    document.getElementById('genBtn').disabled = false;
                    document.getElementById('genBtn').textContent = 'é‡æ–°ç”ŸæˆäºŒç»´ç ';
                    document.getElementById('genBtn').style.display = 'block';
                    return;
                }
                
                if (data.success) {
                    const status = document.getElementById('status');
                    
                    if (data.status === '0') {
                        status.className = 'status waiting';
                        status.textContent = 'ç­‰å¾…æ‰«ç ...';
                    } else if (data.status === '2') {
                        status.className = 'status scanned';
                        status.textContent = 'âœ… å·²æ‰«ç ï¼Œè¯·åœ¨æ‰‹æœºä¸Šç¡®è®¤ç™»å½•';
                    }else if (data.status === '4') {
                        status.className = 'status cancel';
                        status.textContent = 'âœ… å·²å–æ¶ˆï¼Œè¯·é‡æ–°è·å–äºŒç»´ç ';
                        // log('ğŸ“± æ£€æµ‹åˆ°æ‰«ç ');
                    } else if (data.status === '3') {
                        status.className = 'status success';
                        status.textContent = 'âœ… ç¡®è®¤æˆåŠŸï¼Œæ­£åœ¨æ£€æŸ¥ç”¨æˆ·...';
                        
                        clearInterval(pollInterval);
                        if (timerInterval) clearInterval(timerInterval);
                        if (keepaliveInterval) clearInterval(keepaliveInterval);
                        
                        currentStateKey = data.stateKey;
                        currentUserId = data.userId;
                        currentUsername = data.username;
                                                
                        await completeLogin();
                    }
                }
            } catch (error) {
                console.error('è½®è¯¢å¤±è´¥:', error);
            }
        }, 2000);
    }
    
    async function startKeepalive() {
        if (keepaliveInterval) clearInterval(keepaliveInterval);
        
        await keepalive();
        
        keepaliveInterval = setInterval(async () => {
            await keepalive();
        }, 60 * 1000);
    }
    
    async function keepalive() {
        try {
            const response = await fetch('/api/keepalive', {
                method: 'POST',
                credentials: 'include'
            });
            
            const data = await response.json();
            
            if (!data.success)                 
                console.warn('âš ï¸  ä¿æ´»å¤±è´¥:', data.error);  
        } catch (error) {
            console.error('âŒ ä¿æ´»è¯·æ±‚å¤±è´¥:', error);
        }
    }
    
    async function completeLogin() {
        const semester_start = document.getElementById('semester_start').value;
        const email = document.getElementById('email').value || null; // ğŸ†• è·å–é‚®ç®±
        const result = document.getElementById('result');
        const status = document.getElementById('status');
        
        status.textContent = 'æ­£åœ¨éªŒè¯ç”¨æˆ·ä¿¡æ¯...';
        log('ğŸ” æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨...');
        
        try {
            const response = await fetch('/api/qr/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({
                    qrCodeId: currentQrCodeId,
                    stateKey: currentStateKey,
                    semester_start: semester_start,
                    email: email // ğŸ†• å‘é€é‚®ç®±
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                const url = window.location.origin + '/schedule/' + data.token;
                
                if (data.existing) {
                    status.className = 'status existing';
                    status.textContent = 'âœ… æ£€æµ‹åˆ°å·²å­˜åœ¨çš„è®¢é˜…ï¼';
                    log('ğŸ‰ æ— éœ€é‡æ–°ç”Ÿæˆï¼Œä½¿ç”¨åŸè®¢é˜…é“¾æ¥');
                    
                    result.className = 'result existing';
                    result.innerHTML = `
                        <h3 style="margin-bottom: 10px;">ğŸ” æ£€æµ‹åˆ°æ‚¨å·²æœ‰è®¢é˜…é“¾æ¥ï¼</h3>
                        <p style="margin: 10px 0; color: #0366d6;">æ— éœ€é‡æ–°ç”Ÿæˆï¼Œä»¥ä¸‹æ˜¯æ‚¨çš„åŸè®¢é˜…é“¾æ¥ï¼š</p>
                        <p style="background: white; padding: 10px; border-radius: 4px; word-break: break-all;">
                            <code>${url}</code>
                        </p>
                        <div class="action-buttons">
                            <button class="btn-copy" onclick="copyToClipboard('${url}')">ğŸ“‹ å¤åˆ¶é“¾æ¥</button>
                            <button class="btn-copy" onclick="downloadICS('${data.token}')" style="background: #6f42c1;">ğŸ“¥ ä¸‹è½½è¯¾è¡¨</button>
                            <button class="btn-delete" onclick="deleteAccount('${data.token}')">ğŸ—‘ï¸ åˆ é™¤è´¦å·</button>
                        </div>
                        <p style="margin-top: 15px; color: #666; font-size: 14px;">
                            ğŸ’¡ å°†è®¢é˜…é“¾æ¥æ·»åŠ åˆ°æ—¥å†åº”ç”¨ï¼Œæˆ–ç›´æ¥ä¸‹è½½ ICS æ–‡ä»¶å¯¼å…¥
                        </p>
                    `;
                } else {
                    status.className = 'status success';
                    status.textContent = 'âœ… ç™»å½•æˆåŠŸï¼';
                    log('ğŸ‰ è®¢é˜…é“¾æ¥ç”ŸæˆæˆåŠŸ');

                    result.className = 'result success';
                    result.innerHTML = `
                        
                        <h3 style="margin-bottom: 10px;">ğŸ‰ è®¢é˜…é“¾æ¥ç”ŸæˆæˆåŠŸï¼</h3>
                        <p style="margin: 10px 0;"><strong>è®¢é˜…é“¾æ¥ï¼š</strong></p>
                        <p style="background: white; padding: 10px; border-radius: 4px; word-break: break-all;">
                            <code>${url}</code>
                        </p>
                        <!-- ğŸ†• é‚®ç®±ç®¡ç† -->
                        <div style="margin-top: 20px; padding: 15px; background: #f6f8fa; border-radius: 6px;">
                            <h4>ğŸ“§ é‚®ä»¶é€šçŸ¥è®¾ç½®</h4>
                            <input type="email" id="update-email" placeholder="è¾“å…¥é‚®ç®±æ¥æ”¶é€šçŸ¥" value="${email || ''}">
                            <button onclick="updateEmail('${data.token}')">ä¿å­˜é‚®ç®±</button>
                        </div>
                        <div class="action-buttons">
                            <button class="btn-copy" onclick="copyToClipboard('${url}')">ğŸ“‹ å¤åˆ¶é“¾æ¥</button>
                            <button class="btn-copy" onclick="downloadICS('${data.token}')" style="background: #6f42c1;">ğŸ“¥ ä¸‹è½½è¯¾è¡¨</button>
                            <button class="btn-delete" onclick="deleteAccount('${data.token}')">ğŸ—‘ï¸ åˆ é™¤è´¦å·</button>
                        </div>
                        <p style="margin-top: 15px; color: #666; font-size: 14px;">
                            ğŸ’¡ å°†è®¢é˜…é“¾æ¥æ·»åŠ åˆ°æ—¥å†åº”ç”¨ï¼Œæˆ–ç›´æ¥ä¸‹è½½ ICS æ–‡ä»¶å¯¼å…¥
                        </p>
                    `;

                }
                
                result.style.display = 'block';
            } else {
                status.className = 'status error';
                status.textContent = 'âŒ ç™»å½•å¤±è´¥';
                result.className = 'result error';
                result.innerHTML = '<strong>é”™è¯¯:</strong> ' + data.error;
                result.style.display = 'block';
                log('âŒ ' + data.error);
                
                document.getElementById('genBtn').disabled = false;
                document.getElementById('genBtn').textContent = 'é‡æ–°ç”ŸæˆäºŒç»´ç ';
                document.getElementById('genBtn').style.display = 'block';
            }
        } catch (error) {
            status.className = 'status error';
            status.textContent = 'âŒ ç½‘ç»œé”™è¯¯';
            result.className = 'result error';
            result.innerHTML = '<strong>é”™è¯¯:</strong> ' + error.message;
            result.style.display = 'block';
            log('âŒ ' + error.message);
            
            document.getElementById('genBtn').disabled = false;
            document.getElementById('genBtn').textContent = 'é‡æ–°ç”ŸæˆäºŒç»´ç ';
            document.getElementById('genBtn').style.display = 'block';
        }
    }
    
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        }).catch(() => {
            alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
        });
    }
    
    function downloadICS(token) {
        const downloadUrl = window.location.origin + '/api/download/' + token;
        window.location.href = downloadUrl;
    }
    
    async function deleteAccount(token) {
        const confirmed = confirm(
            'âš ï¸ ç¡®å®šè¦åˆ é™¤è´¦å·å—ï¼Ÿ\n\n' +
            'åˆ é™¤åï¼š\n' +
            'â€¢ è®¢é˜…é“¾æ¥å°†ç«‹å³å¤±æ•ˆ\n' +
            'â€¢ æ‰€æœ‰æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤\n' +
            'â€¢ æ—¥å†åº”ç”¨ä¸­çš„è¯¾è¡¨å°†æ— æ³•æ›´æ–°\n\n' +
            'æ­¤æ“ä½œä¸å¯æ¢å¤ï¼'
        );
        
        if (!confirmed) {
            return;
        }
        
        try {
            const response = await fetch('/api/user/' + token, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('âœ… ' + data.message);
                
                document.getElementById('result').innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <h3 style="color: #28a745; margin-bottom: 10px;">âœ… è´¦å·å·²åˆ é™¤</h3>
                        <p style="color: #666;">æ‚¨çš„è®¢é˜…é“¾æ¥å·²å¤±æ•ˆ</p>
                        <p style="color: #666; margin-top: 10px;">å¦‚éœ€ç»§ç»­ä½¿ç”¨ï¼Œè¯·é‡æ–°æ‰«ç ç™»å½•</p>
                        <button class="btn-copy" onclick="location.reload()" style="margin-top: 15px;">
                            ğŸ”„ é‡æ–°å¼€å§‹
                        </button>
                    </div>
                `;
            } else {
                alert('âŒ åˆ é™¤å¤±è´¥ï¼š' + data.error);
            }
        } catch (error) {
            alert('âŒ ç½‘ç»œé”™è¯¯ï¼š' + error.message);
        }
    }

    async function updateEmail(token) {
        const email = document.getElementById('update-email').value;
        if (!email) {
            alert('è¯·è¾“å…¥é‚®ç®±åœ°å€');
            return;
        }
        
        const response = await fetch(`/api/user/${token}/email`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email })
        });
        
        const data = await response.json();
        if (data.success) {
            alert('âœ… é‚®ç®±å·²ä¿å­˜ï¼Œå°†æ”¶åˆ°æµ‹è¯•é‚®ä»¶');
        } else {
            alert('âŒ ' + data.error);
        }
    }
    
    window.addEventListener('beforeunload', () => {
        if (pollInterval) clearInterval(pollInterval);
        if (timerInterval) clearInterval(timerInterval);
        if (keepaliveInterval) clearInterval(keepaliveInterval);
    });
    
    window.addEventListener('DOMContentLoaded', () => {
        generateQR();
    });
    </script>
</body>
</html>